# Modelo Facebook Prophet

```{r echo=FALSE, message=FALSE, warning=FALSE}

library(tseries)
library(readxl)
library(dplyr)
library(forecast)
library(ggplot2)
library(fpp3)
library(fable)
library(fabletools)
library(fable.prophet)
library(tsibble)
library(fpp3)
library(prophet)

```


```{r echo=FALSE, message=FALSE, warning=FALSE}

data <- read_excel("~/0. MCD/3/TS/unidad 2/data.xlsx", sheet = "220m")

data$date <- as.Date(data$date,format = "%Y/%m/%d")

attach(data)

c220.ts <- ts(sqrt(c220), start = c(2015,1), frequency=12)

c220i.ts <- diff(c220.ts, lag = 1)

```


```{r echo=FALSE, message=FALSE, warning=FALSE}

humidity.ts <- ts(sqrt(humidity), start = c(2015,1), frequency=12)
humidity_i.ts <- diff(humidity.ts, lag = 1)


rainfall.ts <- ts(sqrt(rainfall), start = c(2015,1), frequency=12)
rainfall_i.ts <- diff(rainfall.ts, lag = 1)

tmax.ts <- ts(sqrt(tmax), start = c(2015,1), frequency=12)
tmax_i.ts <- diff(tmax.ts, lag = 1)

```


```{r echo=FALSE, message=FALSE, warning=FALSE}

new_data <- data.frame(
  ds=data$date[2:84], 
  y=as.numeric(c220i.ts), 
  hum=as.numeric(humidity_i.ts), 
  rain=as.numeric(rainfall_i.ts), 
  temp=as.numeric(tmax_i.ts))

```


```{r echo=FALSE, message=FALSE, warning=FALSE}

new_data$ds <- format(new_data$ds, "%Y-%m")
new_data$ds <- paste(new_data$ds, "01", sep = "-")
new_data$ds <- as.Date(new_data$ds)

```


Para comenzar, se retoma la gráfica de la variable de Casos de Dengue Grave transformada a través del operador diferencia y rezagada un periodo.


```{r}

autoplot(c220i.ts)

```

Ahora, se realiza una partición de la serie para contar con un subconjunto de prueba y otro de entrenamiento. Se eligió realizar un pronóstico de corto plazo, dada la variabildad histórica y los elementos de contexto de la vigilancia epidemiológica.

```{r}

df <- new_data

# Dividir los datos en entrenamiento y prueba
train_data <- df[df$ds < '2021-11-01', ]  
test_data <- df[df$ds >= '2021-11-01', ] 

```


Se ajustan dos modelos: un modelo ARIMA y el otro basado en el algoritmo Prophet.

```{r}

# Ajustar un modelo ARIMA
model_arima <- auto.arima(train_data$y)

# Generar pronósticos con el modelo ARIMA
forecast_arima <- forecast(model_arima, h = nrow(test_data))

# Ajustar un modelo Prophet y agregar estacionalidad
model_prophet <- prophet()
model_prophet <- fit.prophet(model_prophet, train_data)

# Generar pronósticos con el modelo Prophet
forecast_prophet <- predict(model_prophet, test_data, freq = 'month')

```

Se observa el pronóstico del modelo Prophet, incluyendo un intérvalo de confianza.

```{r}
forecast = predict(model_prophet, forecast_prophet)
plot(model_prophet, forecast)
```

Se calculan las métricas de desempeño para los dos modelos.


```{r echo=FALSE, message=FALSE, warning=FALSE, paged.print=FALSE}


# Calcular las métricas de desempeño para ARIMA
accuracy_arima <- data.frame(
  Model = "ARIMA",
  MAE = Metrics::mae(test_data$y, forecast_arima$mean),
  RMSE = Metrics::rmse(test_data$y, forecast_arima$mean)
)

# Calcular las métricas de desempeño para Prophet
accuracy_prophet <- data.frame(
  Model = "Prophet",
  MAE = mean(abs(test_data$y - forecast_prophet$yhat)),
  RMSE = sqrt(mean((test_data$y - forecast_prophet$yhat)^2))
)

# Crear tabla de métricas
metrics_table <- rbind(accuracy_arima, accuracy_prophet)

print(metrics_table)






```

En este caso, sorprende que el que tenga mejor comportamiento sea el modelo ARIMA. En otras prubas realizadas en la etapa de preparación, el modelo Prophet tuvo un mejor desempeño, aunque por poco.


A continuación se presenta una gráfica de los pronósticos de los dos modelos.

```{r echo=FALSE, message=FALSE, warning=FALSE}

library(ggplot2)

# Crear un dataframe con los datos originales y los pronósticos de los dos modelos
forecast_data <- data.frame(
  ds = test_data$ds,
  y = test_data$y,
  ARIMA = forecast_arima$mean,
  Prophet = forecast_prophet$yhat
)

# Convertir la columna 'ds' al formato de fecha
forecast_data$ds <- as.Date(forecast_data$ds)

# Graficar la serie original y los pronósticos
ggplot(forecast_data, aes(x = ds)) +
  geom_line(aes(y = y, color = "Original"), linetype = "solid") +
  geom_line(aes(y = ARIMA, color = "ARIMA"), linetype = "dashed") +
  geom_line(aes(y = Prophet, color = "Prophet"), linetype = "dotted") +
  labs(title = "Comparación de Pronósticos",
       x = "Fecha",
       y = "Valor") +
  scale_color_manual(values = c("Original" = "black", "ARIMA" = "blue", "Prophet" = "red")) +
  theme_minimal()


```

Aquí se validaría la necesidad de incorporar otras variables predictoras, de modo que se pueda aprovechar más las capacidades del algoritmo Prophet.

En todo caso, hasta este punto se podría decir que después de someterse a un proceso de manipulación efectiva, los registros de Casos de Dengue Grave en Cali se convierten en una serie de tiempo viable para utilizar el enfoque de regresión, toda vez que no representa una variable categórica y presenta una dinámica estacionaria.




